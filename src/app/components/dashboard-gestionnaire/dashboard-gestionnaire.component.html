<ngx-spinner
  bdColor="rgba(51,51,51,0.8)"
  size="medium"
  color="#fff"
  type="ball-scale-multiple"
>
  <p style="font-size: 20px; color: white">CHARGEMENT...</p>
</ngx-spinner>

<div id="main">
  <section class="dash" [class.dash--wide]="!sidebarOpen">

    <!-- ENTÊTE / HERO -->
    <header class="hero">
      <div class="hero__text">
        <h1 class="hero__title">
          Heureux de vous revoir,
          <span class="hero__accent">{{ user.prenom }} {{ user.nom }}</span>
        </h1>
        <p class="hero__subtitle">Gérez vos projets en toute simplicité.</p>

        <div class="hero__cta">
          <button class="btn btn--primary" (click)="voirTous()">
            <i class="ri-layout-grid-line"></i> Tous les projets
          </button>
          <button class="btn btn--ghost" (click)="voirMois()">
            <i class="ri-eye-off-line"></i> Voir moins
          </button>
        </div>
      </div>

      <div class="hero__image">
        <!-- on garde ton chemin -->
        <img src="/gestionnnairedashboard.png" alt="Illustration dashboard"/>
      </div>
    </header>

    <!-- STATS EN TUILES -->
    <section class="stats" [class.stats--compact]="!sidebarOpen">
      <article class="stat">
        <div class="stat__icon bg--blue"><i class="ri-archive-stack-line"></i></div>
        <div class="stat__content">
          <h4 class="stat__label">Projets en cours</h4>
          <div class="stat__value">{{ nbreProjetsEnCours }}</div>
        </div>
      </article>

      <article class="stat">
        <div class="stat__icon bg--green"><i class="ri-check-double-line"></i></div>
        <div class="stat__content">
          <h4 class="stat__label">Projets réalisés</h4>
          <div class="stat__value">{{ nbreProjetsTermine }}</div>
        </div>
      </article>

      <article class="stat">
        <div class="stat__icon bg--amber"><i class="ri-team-line"></i></div>
        <div class="stat__content">
          <h4 class="stat__label">Contributions à valider</h4>
          <div class="stat__value">{{ contributionsList.length || 0 }}</div>
        </div>
      </article>
    </section>

    <!-- DEUX COLONNES : CONTRIBUTIONS + PROJETS -->
    <section class="grid-2">
      <!-- CONTRIBUTIONS À VALIDER -->
      <aside class="panel panel--list">
        <div class="panel__head">
          <h3 class="panel__title">Contributions à valider</h3>
          <button class="btn btn--link">Tous voir</button>
        </div>

        <div class="panel__body panel__body--scroll">
          @for (contributions of contributionsList; track $index) {
            <app-cardcontribution [contribution]="contributions"></app-cardcontribution>
          }
          @if (!contributionsList || contributionsList.length === 0) {
            <div class="panel__empty">
              <i class="ri-inbox-line"></i>
              <p>Aucune contribution en attente</p>
            </div>
          }
        </div>
      </aside>

      <!-- PROJETS (récents / tous) -->
      <section class="panel panel--cards">
        <div class="panel__head">
          @if (tout) {
            <h3 class="panel__title">Tous les projets</h3>
            <button class="btn btn--link" (click)="voirMois()">Voir moins</button>
          } @else {
            <h3 class="panel__title">Projets récents</h3>
            <button class="btn btn--link" (click)="voirTous()">Tous voir</button>
          }
        </div>

        <div class="cards">
          @if (tout) {
            @for (projet of toutProjet; track $index) {
              <app-cardprojet [projets]="projet"></app-cardprojet>
            }
          } @else {
            @for (projet of projetsRecents; track $index) {
              <app-cardprojet [projets]="projet"></app-cardprojet>
            }
          }
          @if ((!tout && (!projetsRecents || projetsRecents.length === 0)) ||
               (tout && (!toutProjet || toutProjet.length === 0))) {
            <div class="panel__empty">
              <i class="ri-folder-info-line"></i>
              <p>Aucun projet à afficher</p>
            </div>
          }
        </div>
      </section>
    </section>

    <!-- DEMANDES DE CONTRIBUTION -->
    <section class="panel panel--table">
      <div class="panel__head">
        <h3 class="panel__title">Demandes de contribution</h3>
      </div>

      <div class="table-wrap">
        <table class="table">
          <thead>
            <tr>
              <th>Projet</th>
              <th>Contributeur</th>
              <th>Date d'envoi</th>
              <th>Profil contributeur</th>
              <th class="th-actions">Actions</th>
            </tr>
          </thead>
          <tbody>
            @if (demandeContributions.length > 0) {
              @for (demande of demandeContributions; track $index) {
                <tr>
                  <td data-label="Projet">{{ demande.projetTitre }}</td>
                  <td data-label="Contributeur">{{ demande.contributeurNom }}</td>
                  <td data-label="Date d'envoi">{{ demande.dateEnvoi | date:'dd/MM/yyyy à hh:mm'}}</td>
                  <td data-label="Profil">{{ demande.profileContributeur }}</td>
                  <td class="actions" data-label="Actions">
                    <button class="btn btn--success" (click)="openPopups('accept', demande)">Accepter</button>
                    <button class="btn btn--danger" (click)="openPopups('decline', demande)">Refuser</button>
                  </td>
                </tr>
              }
            } @else {
              <tr class="tr-empty">
                <td colspan="5">
                  <div class="panel__empty">
                    <i class="ri-mail-forbid-line"></i>
                    <p>Aucune demande en attente</p>
                  </div>
                </td>
              </tr>
            }
          </tbody>
        </table>
      </div>
    </section>

  </section>

  @if (ispopupVisible === true) {
    <app-pop-ups [idDemandeContribution]="idDCV" (close)="closePopups($event)"></app-pop-ups>
  }
</div>
